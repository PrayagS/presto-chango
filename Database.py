import os
from random import random
from Song import song_recipe


# class DataPoint:
#     def __init__(self, time, song_id):
#         self.time = time
#         self.song_id = song_id

def hash_window(filtered_bin):
    """
    :param filtered_bin: A filtered bin of a window generated by filter_spectrogram
    :return: hash value of the particular bin
    """
    fuz_factor = 2  # for error correction TODO: figure out why?

    return (filtered_bin[3] - (filtered_bin[3] % fuz_factor)) * 1e8 + (
            filtered_bin[2] - (filtered_bin[2] % fuz_factor)) * 1e5 + (
                   filtered_bin[1] - (filtered_bin[1] % fuz_factor)) * 1e2 + (
                   filtered_bin[0] - (filtered_bin[0] % fuz_factor))


def hash_song(song_id, filtered_bins, hash_dictionary):
    for filtered_bin in filtered_bins:
        if hash_dictionary[hash_window(filtered_bin)]:
            hash_dictionary[hash_window(filtered_bin)].append(song_id)
        else:
            hash_dictionary[hash_window(filtered_bin)] = [song_id]


def create_database():
    song_to_id = {}
    hash_dictionary = {}
    for filename in os.walk('AudioSamples'):
        song_id = int(random() * 1000)
        song_to_id[filename] = song_id
        filtered_bins = song_recipe(filename)
        hash_song(song_id, filtered_bins, hash_dictionary)
    return song_to_id, hash_dictionary
